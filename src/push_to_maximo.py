import json
import os
from datetime import datetime

# -----------------------------
# CONFIGURATION
# -----------------------------

RUL_THRESHOLD = 30
INPUT_FILE = "outputs/work_orders_fd001.json"
OUTPUT_FILE = "outputs/maximo_ready_payloads.json"

MAXIMO_ENDPOINT = "https://<your-instance>.maximo.com/maximo/api/os/mxwo"

# -----------------------------
# LOAD GENERATED ML OUTPUT
# -----------------------------

with open(INPUT_FILE, "r") as f:
    predictions = json.load(f)

print(f"Loaded {len(predictions)} predictions")

# -----------------------------
# FILTER ELIGIBLE WORK ORDERS
# -----------------------------

eligible = [p for p in predictions if p["predicted_rul_cycles"] < RUL_THRESHOLD]

print(f"Eligible (RUL < {RUL_THRESHOLD}): {len(eligible)}")

# -----------------------------
# BUILD MAXIMO PAYLOADS
# -----------------------------

payloads = []

for item in eligible:

    payload = {
        "description": f"ML Predictive Alert - {item['asset_id']}",
        "longdescription": f"""
Predicted Remaining Useful Life: {item['predicted_rul_cycles']:.2f} cycles

Model: LSTM RUL Predictor
Threshold Trigger: {RUL_THRESHOLD} cycles
Priority: High
Generated: {datetime.utcnow().isoformat()}Z

This work order was automatically generated by the Predictive Maintenance ML pipeline.
""",
        "assetnum": item["asset_id"],
        "siteid": "AMHERST",
        "worktype": "CM",
        "status": "WAPPR",
        "priority": 1
    }

    payloads.append(payload)

# -----------------------------
# SAVE OUTPUT
# -----------------------------

os.makedirs("outputs", exist_ok=True)

with open(OUTPUT_FILE, "w") as f:
    json.dump(payloads, f, indent=4)

print("\nâœ… Maximo-ready payload file created:")
print(f"   {OUTPUT_FILE}")

print("\nðŸš€ Integration Simulation Complete")
print("These payloads are ready to POST to:")
print(MAXIMO_ENDPOINT)

print("\nExample POST command:")
print("""
curl -X POST \\
  https://<your-instance>.maximo.com/maximo/api/os/mxwo \\
  -H "Content-Type: application/json" \\
  -H "apikey: YOUR_API_KEY" \\
  -d @outputs/maximo_ready_payloads.json
""")
